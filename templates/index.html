<!DOCTYPE html>
<html>
<head>
    <title>Telemetric Anomaly Detection in ICS</title>
    <style>
        body {
            position: relative;
            font-family: Arial, sans-serif;
        }
        .plc {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            text-align: center;
            line-height: 80px;
            font-weight: bold;
            border: 2px solid #333;
        }
        /* Different background colors for each PLC */
        #plc-1 { background-color: #8ecae6; }
        #plc-2 { background-color: #219ebc; }
        #plc-3 { background-color: #ffb703; }
        #plc-4 { background-color: #fb8500; }
        /* Red warning banner */
        #warning {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            background-color: red;
            color: white;
            font-weight: bold;
            display: none;
            z-index: 1000;
        }
        /* Anomaly trigger button */
        #anomalyBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        /* SVG overlay for drawing animations */
        #svgOverlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: auto;
            z-index: 500;
        }
    </style>
</head>
<body>
    <div id="warning">Anomaly Detected!</div>
    <button id="anomalyBtn">Trigger Anomaly</button>

    <!-- Four circles representing the four PLCs -->
    <div id="plc-1" class="plc" style="top: 100px; left: 100px;">PLC-1</div>
    <div id="plc-2" class="plc" style="top: 100px; left: 400px;">PLC-2</div>
    <div id="plc-3" class="plc" style="top: 300px; left: 100px;">PLC-3</div>
    <div id="plc-4" class="plc" style="top: 300px; left: 400px;">PLC-4</div>

    <!-- SVG overlay for animation -->
    <svg id="svgOverlay" height="200" width="300" xmlns="http://www.w3.org/2000/svg">
    </svg>


    <script>
        // Connect to the SSE stream provided by the Flask app.
        var evtSource = new EventSource("/stream");
        evtSource.onmessage = function(e) {
            var event = JSON.parse(e.data);
            console.log("Received event:", event);

            if (event.event === "message") {
                animateMessage(event.sender, event.receiver);
            } else if (event.event === "anomaly") {
                showWarning(event.message);
            }
            // Additional event types (e.g., "waiting" or "stopped") can be handled here.
        };

        // Helper function: returns the center point (x,y) of a DOM element.
        function getCenter(element) {
            var rect = element.getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
        }

        // Animate a “packet” traveling from sender to receiver.
        function animateMessage(senderName, receiverName) {
            // Convert names like "PLC-1" to corresponding element IDs ("plc-1")
            var senderElem = document.getElementById(senderName.toLowerCase());
            var receiverElem = document.getElementById(receiverName.toLowerCase());

            if (!senderElem || !receiverElem) {
                console.error("Sender or Receiver element not found");
                return;
            }

            // Get centers of the sender and receiver in viewport coordinates.
            var senderCenter = getCenter(senderElem);
            var receiverCenter = getCenter(receiverElem);

            // Adjust the coordinates relative to the SVG overlay.
            var svg = document.getElementById("svgOverlay");
            var svgRect = svg.getBoundingClientRect();
            var start = {
                x: senderCenter.x - svgRect.left,
                y: senderCenter.y - svgRect.top
            };
            var end = {
                x: receiverCenter.x - svgRect.left,
                y: receiverCenter.y - svgRect.top
            };

            // Create an SVG line that will animate from the sender to receiver.
            var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", start.x);
            line.setAttribute("y1", start.y);
            line.setAttribute("x2", start.x);
            line.setAttribute("y2", start.y);
            line.setAttribute("style", "stroke:red;stroke-width:2")
            svg.appendChild(line);

            // Animate the line extending to the end point.
            var duration = 500; // milliseconds
            var startTime = null;
            function animate(time) {
                if (!startTime) startTime = time;
                var progress = (time - startTime) / duration;
                if (progress > 1) progress = 1;
                var currentX = start.x + (end.x - start.x) * progress;
                var currentY = start.y + (end.y - start.y) * progress;
                line.setAttribute("x2", currentX);
                line.setAttribute("y2", currentY);
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Remove the line after a short delay.
                    setTimeout(function() {
                        if(line.parentNode){
                          line.parentNode.removeChild(line);
                        }
                    }, 200);
                }
            }
            requestAnimationFrame(animate);
        }

        // Show a red warning message when an anomaly is detected.
        function showWarning(message) {
            var warningDiv = document.getElementById("warning");
            warningDiv.textContent = message;
            warningDiv.style.display = "block";
            // Hide the warning after 5 seconds.
            setTimeout(function() {
                warningDiv.style.display = "none";
            }, 5000);
        }

        // Handle the anomaly trigger button.
        document.getElementById("anomalyBtn").addEventListener("click", function() {
            fetch("/trigger_anomaly", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                });
        });
    </script>
</body>
</html>
